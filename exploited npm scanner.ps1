$foundAny = $false

foreach ($file in $packageFiles) {
    try {
        $json = Get-Content $file.FullName -Raw | ConvertFrom-Json -ErrorAction Stop

        foreach ($pkg in $packages.Keys) {
            $expected = $packages[$pkg]

            $found = $null
            if ($json.dependencies.$pkg) { $found = $json.dependencies.$pkg }
            elseif ($json.devDependencies.$pkg) { $found = $json.devDependencies.$pkg }

            if ($found -eq $expected) {
                Write-Host "⚠️  FOUND: $pkg@$expected in $($file.FullName)" -ForegroundColor Red
                $foundAny = $true
            }
        }
    } catch {
        # Ignore JSON parse errors
    }
}

Write-Host "`n--------------------------------------------------"

if ($foundAny) {
    Write-Host "❌ WARNING: Your system contains compromised npm packages!" -ForegroundColor Red
    Write-Host "Please remove or update the affected dependencies immediately." -ForegroundColor Yellow
} else {
    Write-Host "✅ SAFE: No compromised npm packages were found." -ForegroundColor Green
}

Write-Host "--------------------------------------------------`n"

Write-Host "Press Enter to exit..." -ForegroundColor Yellow
Read-Host
